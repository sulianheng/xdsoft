package com.xdsoft.mvc.service;

import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import com.xdsoft.mvc.service.CountPageService;
import com.xdsoft.mvc.util.RandOrdernum;

import java.io.*;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.annotation.Resource;

@Service
public class FilesSaveService {

	@Resource
	private OrdersService ordersservice;

	/**
	 * Upload multiple file using Spring Controller
	 */
	public List<Map<String, Object>> uploadMultipleFileHandler(
			MultipartFile[] files, String FilePath, String ordernum_id)
			throws IOException {

		
		List<Map<String, Object>> fileinformation = new ArrayList<Map<String, Object>>();
		List<Map<String, Object>> err = new ArrayList<Map<String, Object>>();

		Map<String, Object> arr = new HashMap<String, Object>();
		for (int i = 0; i < files.length; i++) {
			MultipartFile file = files[i];

			String rootPath = System.getProperty("catalina.home");
			File dir = new File(rootPath + File.separator + FilePath);
			String Filename = file.getOriginalFilename();
			String suffix = file.getOriginalFilename().substring(
					file.getOriginalFilename().lastIndexOf("."));
			String fileunique = RandOrdernum.getOrderNo();
			String FileSavename = fileunique + suffix;

			if (!file.isEmpty()) {
				InputStream in = null;
				OutputStream out = null;

				if (!dir.exists())
					dir.mkdirs();
				File serverFile = new File(dir.getAbsolutePath()
						+ File.separator + FileSavename);
				Map<String, Object> map = ordersservice.CreateTempFileInfomation(ordernum_id, Filename, serverFile.getCanonicalPath(), fileunique);
				fileinformation.add(map);

				try {

					in = file.getInputStream();
					out = new FileOutputStream(serverFile);
					byte[] b = new byte[1024];
					int len = 0;
					while ((len = in.read(b)) > 0) {
						out.write(b, 0, len);
					}
					out.close();
					in.close();

				} catch (Exception e) {
					arr.put("Experrno", i);
					err.add(arr);
				} finally {
					if (out != null) {
						out.close();
						out = null;
					}

					if (in != null) {
						in.close();
						in = null;
					}
				}

			} else {
				arr.put("errno", i);
				err.add(arr);
			}

		}

		return fileinformation;
	}

	
	public String CountPage(String FilesUrl) {

		CountPageService cp = new CountPageService(true);

		String pages = cp.countPage(FilesUrl);

		cp.close();



		return pages;

	}
	
	
	
	/*
	 * 
	 * 
	 * 
	 * 文库文件上传
	 * 
	 * 
	 */
	
	public Map<String, Object> bunkoUploadFile(
			MultipartFile files, String FilePath, String ordernum_id)
			throws IOException {

		
			Map<String, Object> fileinformation = new HashMap<String, Object>();
			Map<String, Object> arr = new HashMap<String, Object>();
			
			String filename = files.getOriginalFilename();
			String rootPath = System.getProperty("catalina.home");
			File dir = new File(rootPath + File.separator + FilePath);
			String suffix = files.getOriginalFilename().substring(
					files.getOriginalFilename().lastIndexOf("."));
			String fileunique = RandOrdernum.getOrderNo();
			String FileSavename = fileunique + suffix;
			
			
			if (!files.isEmpty()) {
				
							InputStream in = null;
							OutputStream out = null;

							if (!dir.exists())
								dir.mkdirs();
						File serverFile = new File(dir.getAbsolutePath()
						+ File.separator + FileSavename);
						
						fileinformation.put("fileunique", fileunique);
						fileinformation.put("path",  serverFile.getCanonicalPath());
						fileinformation.put("suffix", suffix);
						

						try {
								in = files.getInputStream();
								out = new FileOutputStream(serverFile);
								byte[] b = new byte[1024];
								int len = 0;
								while ((len = in.read(b)) > 0) {
									out.write(b, 0, len);
										}
							out.close();
							in.close();

							} catch (Exception e) {
							arr.put("Experrno", 0);
						
							} finally {
								if (out != null) {
									out.close();
									out = null;
								}

								if (in != null) {
									in.close();
									in = null;
								}
							}
							
				}else {
					arr.put("errno", 0);
						
			}
		return fileinformation;
	}
	
	
	
	/*
	 * 
	 * 
	 * 
	 */
}
	
	
	
	
	
	
	
	
	
	
	
	
	
	

